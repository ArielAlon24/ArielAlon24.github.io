<!DOCTYPE html>
<html>
    <head>
        <title> Ariel Alon </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="/styles.css">
        <script data-goatcounter="https://arielalon.goatcounter.com/count" src="//gc.zgo.at/count.js"></script>
    </head>
    <body>
        <nav class="navbar">
            <div class="left-nav">
                <a href="/"> Ariel Alon </a>
            </div>
            <div class="right-nav">
                <a href="https://github.com/ArielAlon24">
                    <img src="/assets/github-mark.svg" alt="Github Icon" class="icon">
                </a>
            </div>
        </nav>
        <article>
            <div class="heading">
                <h1> Class Property Decorator </h1>
                <p> 02-02-2024 </p>
            </div>
            <h2>Background</h2>
<p>One day, my cousin, a Python backend engineer, introduced me to a problem his team encountered that week at work, but couldn't solve.</p>
<h2>Problem</h2>
<p>If you're familiar with Python's properties and classmethods, a specific feature might seem missing - why isn't there a decorator for class properties? A classmethod which is also a decroator.</p>
<p>Consider a class named <code>A</code> with a class attribute <code>metadata</code> that needs to be computed each time it's accessed. However, the computation isn't particularly intensive. Without a <code>class_property</code> decorator, it would look something like this:</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>

<p>This isn't convenient as we want to provide a way for the user to interact with metadata as a class attribute rather than a function.</p>
<h2>Investigation</h2>
<p>My first thought for solving this problem was to chain decorators - using both <code>classmethod</code> and <code>property</code>. However, to my surprise, this exact functionality is deprecated from Python 3.11, as mentioned in the <a href="https://docs.python.org/3/howto/descriptor.html#class-methods">Python docs</a>.</p>
<p>I quickly realized descriptors could do the job, but I wasn't sure how. I started with the <code>__init__</code> method of the <code>class_property</code>, that will get the method it decorates as an argument. For naming conventions, I created a private class <code>_ClassProperty</code> and then renamed it to <code>class_property</code>. We will ignore the last assignment from now on:</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">_ClassProperty</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span>

<span class="n">class_property</span> <span class="o">=</span> <span class="n">_ClassProperty</span>
</code></pre></div></td></tr></table></div>

<p>For correct type hints I'll use a generic <code>T</code> to mark the given method return type:</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Callable</span>


<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ClassProperty</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
</code></pre></div></td></tr></table></div>

<p>Now for the interesting part, how can I call the <code>method</code> argument on access to a <code>_ClassProperty</code>? If you're familiar with Python's descriptor protocol, you'll certainly know the answer, otherwise here's a brief explenation.</p>
<h2>Brief overview on descriptor's <code>__get__</code> method</h2>
<p>Luckily, the <a href="https://docs.python.org/3/howto/descriptor.html#descriptor-howto-guide">Python descriptor protocol</a> allows implementing a <code>__get__(self, obj, objtype=None)</code> method. This method is called when a descriptor as an attribute is being accessed. For example:</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Ten</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">10</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Ten</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>&gt;&gt;&gt;<span class="w"> </span>a.y<span class="w">     </span><span class="c1"># Triggers the __get__ method (obj=a, objtype=A)</span>
<span class="m">10</span>
</code></pre></div></td></tr></table></div>

<h2>Solution?</h2>
<p>By using the <code>__get__</code> method, we can execute the <code>_ClassProperty</code> method and even supply it with the correct <code>cls</code> parameter (named <code>owner</code> for readability.):</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">_ClassProperty</span><span class="p">:</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">owner</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Owner must not be None (unreachable).&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>This method can be called in two ways:</p>
<ol>
<li>on a class: Python will pass <code>owner=&lt;class-type&gt;</code>.</li>
<li>on an instance: Python will provide the owner of the instance (the instance's type).</li>
</ol>
<p>The <code>if</code> block exists mainly for safety, as there's no straightforward way (without special workarounds) to access this <code>__get__</code> with <code>owner=None</code>.</p>
<h2>Oh no</h2>
<p>This approach looked promising and worked quite well, but it had a flaw. The need for this feature arose for use with Pydantic's <code>BaseModel</code>, but when used together, an error occurrs:</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="go">raise PydanticUserError(</span>
<span class="go">pydantic.errors.PydanticUserError: A non-annotated attribute was detected: `metadata = &lt;class_property._ClassProperty object at 0x103559d10&gt;`. All model fields require a type annotation; if `metadata` is not meant to be a field, you may be able to resolve this error by annotating it as a `ClassVar` or updating `model_config[&#39;ignored_types&#39;]`.</span>
</code></pre></div></td></tr></table></div>

<p>This was curious. How do regular <code>property</code>s work with Pydantic's <code>BaseModel</code>, and why don't they raise this error? Ignoring this entire curiosity an idea popped up - why not inherit from <code>property</code> itself:</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Callable</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ClassProperty</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">owner</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Owner must not be None (unreachable).&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<h2>Additional Safeguards</h2>
<p>Just to ensure this decorator isn't being misused, I added an additional check for correct arguments. As a method decorated by <code>class_property</code> is both a <code>classmethod</code> and a <code>property</code>, it should only have <code>cls</code> as an argument. Using the <code>inspect</code> module, we can access the method's signature and validate its parameters. Finally, at 23 lines of code, we have it - a <code>class_property</code> decorator:</p>
<div class="code"><table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">inspect</span>


<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ClassProperty</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="n">PARAMETERS</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;cls&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect arguments, expected: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">owner</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Owner must not be None (unreachable).&quot;</span><span class="p">)</span>


<span class="n">class_property</span> <span class="o">=</span> <span class="n">_ClassProperty</span>
</code></pre></div></td></tr></table></div>
        </article>
    </body>
</html>